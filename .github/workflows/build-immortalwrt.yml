#============================================================================================
# https://github.com/ophub/amlogic-s9xxx-openwrt
# Description: Build OpenWrt
#============================================================================================

name: Build Immortalwrt

on:
  # GitHub 仓库中通过调度事件（repository_dispatch）触发
  repository_dispatch:
  # GitHub 仓库中手动触发（workflow_dispatch）
  workflow_dispatch:
    # 定义工作流的输入参数
    inputs:
      defconfig_config:
        description: "Select the .config branch in defconfig"
        required: true
        default: "mt7981-ax3000"
        type: choice
        options:
          - mt7981-ax3000
          - mt7986-ax6000
          - mt7986-ax6000-256m
      builder_name:
        description: "Set OpenWrt builder signature."
        required: false
        default: "yourname"
        type: string

env:
  REPO_URL: https://github.com/grinch27/immortalwrt-mt798x
  REPO_BRANCH: openwrt-21.02
  TZ: America/New_York
  # ETC
  FEEDS_CONF: ${GITHUB_WORKSPACE}/openwrt/feeds.conf.default
  CONFIG_FILE: ${GITHUB_WORKSPACE}/openwrt/defconfig/${{ inputs.defconfig_config }}.config
  DIY_P1_SH: ${GITHUB_WORKSPACE}/openwrt/config/immortalwrt-master/diy-part1.sh
  DIY_P2_SH: ${GITHUB_WORKSPACE}/openwrt/config/immortalwrt-master/diy-part2.sh

jobs:
  build:
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@master

      - name: Initialization environment
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          # 删除所有 Docker 镜像
          docker rmi $(docker images -q) 2>/dev/null
          # 如果环境变量 AGENT_TOOLSDIRECTORY 不为空，则删除该目录及其所有内容
          [[ -n "${AGENT_TOOLSDIRECTORY}" ]] && sudo rm -rf "${AGENT_TOOLSDIRECTORY}"
          # 删除指定的目录及其所有内容，忽略所有错误信息
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null
          # 关闭所有交换空间
          sudo swapoff -a
          # 删除指定的交换文件
          sudo rm -f /swapfile /mnt/swapfile
          # 更新 Ubuntu 的软件包列表
          sudo -E apt-get -y update
          # 删除指定的软件包及其配置文件。如果删除失败，则忽略错误
          sudo -E apt-get -y purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          # 下载并安装指定 URL 中列出的软件包
          # sudo -E apt-get -y install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
          # sudo apt-get install -y build-essential libncursesw5-dev libreadline6-dev libssl-dev libgdbm-dev libc6-dev libsqlite3-dev tk-dev libbz2-dev
          sudo -E apt-get -y install \
          ack \
          antlr3 \
          asciidoc \
          autoconf \
          automake \
          autopoint \
          binutils \
          bison \
          build-essential \
          bzip2 \
          ccache \
          clang \
          clangd \
          cmake \
          cpio \
          curl \
          device-tree-compiler \
          ecj \
          fastjar \
          flex \
          gawk \
          gettext \
          gcc-multilib \
          g++-multilib \
          git \
          gperf \
          haveged \
          help2man \
          intltool \
          lib32gcc-s1 \
          libc6-dev-i386 \
          libelf-dev \
          libglib2.0-dev \
          libgmp3-dev \
          libltdl-dev \
          libmpc-dev \
          libmpfr-dev \
          libncurses5-dev \
          libncursesw5 \
          libncursesw5-dev \
          libreadline-dev \
          libssl-dev \
          libtool \
          lld \
          lldb \
          lrzsz \
          mkisofs \
          msmtp \
          nano \
          ninja-build \
          p7zip \
          p7zip-full \
          patch \
          pkgconf \
          python3 \
          python3-docutils \
          python3-pip \
          python3-ply \
          qemu-utils \
          re2c \
          rsync \
          scons \
          squashfs-tools \
          subversion \
          swig \
          texinfo \
          uglifyjs \
          unzip \
          vim \
          wget \
          xmlto \
          xxd \
          zlib1g-dev
          # 重新加载 systemd 的配置
          sudo -E systemctl daemon-reload
          # 删除所有不再需要的软件包及其配置文件
          sudo -E apt-get -y autoremove --purge
          # 清理 apt 的缓存
          sudo -E apt-get clean
          # 从 root 用户的 .bashrc 和 .profile 文件中删除包含 NVM_DIR 和 skel 的行
          sudo sed -i '/NVM_DIR/d;/skel/d' /root/{.bashrc,.profile}
          # 删除指定的目录及其所有内容
          sudo rm -rf ~/{.cargo,.dotnet,.rustup}
          # 设置系统的时区为环境变量 TZ 指定的值
          sudo timedatectl set-timezone "${TZ}"
          # 将 "status=success" 写入环境变量 GITHUB_OUTPUT 指定的文件
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Create simulated physical disk
        run: |
          # 计算 /mnt 分区的可用空间（减去 1GB 作为缓冲）
          mnt_size=$(expr $(df -h /mnt | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 1)
          # 计算根分区的可用空间（减去 4GB 作为缓冲）
          root_size=$(expr $(df -h / | tail -1 | awk '{print $4}' | sed 's/[[:alpha:]]//g' | sed 's/\..*//') - 4)
          # 创建一个大小为 mnt_size 的文件 /mnt/mnt.img
          sudo truncate -s "${mnt_size}"G /mnt/mnt.img
          # 创建一个大小为 root_size 的文件 /root.img
          sudo truncate -s "${root_size}"G /root.img
          # 将这两个文件关联到 loop 设备
          sudo losetup /dev/loop6 /mnt/mnt.img
          sudo losetup /dev/loop7 /root.img
          # 在这两个 loop 设备上创建物理卷
          sudo pvcreate /dev/loop6
          sudo pvcreate /dev/loop7
          # 创建一个名为 github 的卷组，包含这两个物理卷
          sudo vgcreate github /dev/loop6 /dev/loop7
          # 在 github 卷组上创建一个名为 runner 的逻辑卷，使用所有可用空间
          sudo lvcreate -n runner -l 100%FREE github
          # 在 runner 逻辑卷上创建一个 XFS 文件系统
          sudo mkfs.xfs /dev/github/runner
          # 创建一个挂载点 /builder
          sudo mkdir -p /builder
          # 将 runner 逻辑卷挂载到 /builder
          sudo mount /dev/github/runner /builder
          # 将 /builder 的所有者和组更改为 runner
          sudo chown -R runner.runner /builder
          # 显示所有文件系统的磁盘空间使用情况
          df -Th
          # sudo dd if=/dev/zero of=/tmp/disk.img bs=1M count=1024
          # sudo mkfs.ext2 /tmp/disk.img
          # sudo mkdir /mnt/disk
          # sudo mount -o loop /tmp/disk.img /mnt/disk

      - name: Clone source code
        id: codes
        working-directory: /builder
        if: ${{ steps.init.outputs.status }} == 'success' && !cancelled()
        run: |
          # git clone https://github.com/hanwckf/immortalwrt-mt798x.git
          # git clone $REPO_URL -b $REPO_BRANCH openwrt

          # Clone source code 使用 git clone 命令克隆源代码
          # --quiet 选项表示静默模式，不输出任何信息
          # --single-branch 选项表示只克隆指定的分支
          # --depth=1 选项表示只克隆最近的一次提交
          # --branch=${REPO_BRANCH} 选项表示要克隆的分支，其名称由 REPO_BRANCH 环境变量指定
          # ${REPO_URL} 是要克隆的仓库的 URL，由 REPO_URL 环境变量指定
          # openwrt 是克隆后的本地目录名
          git clone --quiet --single-branch --depth=1 --branch=${REPO_BRANCH} ${REPO_URL} openwrt

          # 创建一个符号链接，链接的源是 /builder/openwrt，目标是 ${GITHUB_WORKSPACE}/openwrt 通过 ${GITHUB_WORKSPACE}/openwrt 访问到 /builder/openwrt
          ln -sf /builder/openwrt ${GITHUB_WORKSPACE}/openwrt

          # Set output information 将构建标签和日期信息写入到 GITHUB_OUTPUT 环境变量指定的文件中
          # echo "build_tag=OpenWrt_${TAGS_NAME}_${{ inputs.openwrt_storage }}_$(date +"%Y.%m")" >> ${GITHUB_OUTPUT}
          echo "build_tag=Immortalwrt_$(date +"%Y.%m")" >> ${GITHUB_OUTPUT}

          # 打印仓库 URL、分支和标签名称
          echo -e "REPO_URL: [ ${REPO_URL} ]\nREPO_BRANCH: [ ${REPO_BRANCH} ]\nTAGS_NAME: [ ${TAGS_NAME} ]"

          # 显示当前工作目录的磁盘空间使用情况
          df -hT ${PWD}

          # 将仓库 URL 写入到 GITHUB_OUTPUT 环境变量指定的文件中
          echo "REPO_URL=${REPO_URL}" >> ${GITHUB_OUTPUT}
          # echo "TAGS_NAME=${TAGS_NAME}" >> ${GITHUB_OUTPUT}

          # 将 "status=success" 写入到 GITHUB_OUTPUT 环境变量指定的文件中
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Load custom feeds
        run: |
          # 检查 FEEDS_CONF 环境变量指定的文件是否存在 如果存在，则将这个文件复制到 openwrt/feeds.conf.default 用于指定 feeds 的源
          [[ -f "${FEEDS_CONF}" ]] && cp -f ${FEEDS_CONF} openwrt/feeds.conf.default

          # 修改 DIY_P1_SH 环境变量指定的文件的权限，使其可以执行
          chmod +x ${DIY_P1_SH}

          # 切换到 openwrt 目录
          cd openwrt/

          # 执行 DIY_P1_SH 环境变量指定的脚本进行一些自定义的操作，如修改配置文件、安装额外的软件包等
          ${DIY_P1_SH}

      - name: Update feeds
        run: cd openwrt/ && ./scripts/feeds update -a

      - name: Install feeds
        run: cd openwrt/ && ./scripts/feeds install -a

      - name: Load custom configuration
        run: |
          # "files" 目录通常包含一些要添加到固件中的文件,检查如果存在"files" 目录，则将目录移动到 openwrt/files
          [[ -d "files" ]] && mv -f files openwrt/files

          # CONFIG_FILE 环境变量指定的文件通常是 OpenWrt 的配置文件，包含了要编译的软件包、目标系统、硬件配置等信息。检查如果存在，则将这个文件复制到 openwrt/.config
          # cp -f $GITHUB_WORKSPACE/.config $GITHUB_WORKSPACE/openwrt/
          echo -e "CONFIG_FILE: ${CONFIG_FILE}"
          [[ -e "${CONFIG_FILE}" ]] && cp -f ${CONFIG_FILE} openwrt/.config

          # 修改 DIY_P2_SH 环境变量指定的脚本文件的权限，使其后面可以执行
          chmod +x ${DIY_P2_SH}

          # 切换到 openwrt 源代码目录
          cd openwrt/

          # 执行 DIY_P2_SH 环境变量指定的脚本 可以进行一些自定义的操作，如修改配置文件、安装额外的软件包等
          ${DIY_P2_SH}

      - name: Download package
        id: package
        run: |
          cd openwrt/
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile the OpenWrt
        id: compile
        run: |
          # 切换到源代码目录
          cd openwrt/

          # 打印出当前系统的 CPU 核心数，并表示将使用这些核心进行编译
          echo -e "$(nproc) thread compile"

          # 使用 make 命令编译 OpenWrt
          # -j$(($(nproc) + 1)) 选项表示并行编译，使用的线程数为 CPU 核心数加 1
          # V=s 选项表示详细模式，会输出详细的编译信息
          # 如果编译失败，则尝试使用单线程编译
          # 如果再次失败，则尝试使用单线程的详细模式编译
          make -j$(($(nproc) + 1)) V=s || make -j1 || make -j1 V=s

          # 将 "status=success" 写入到 GITHUB_OUTPUT 环境变量指定的文件中 表示编译成功
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Copy to output
        id: output
        if: ${{ steps.compile.outputs.status }} == 'success' && !cancelled()
        run: |
          # 切换到源代码目录
          cd openwrt/

          # 检查 "output" 目录是否存在，不存在则创建
          [[ -d "output" ]] || mkdir output

          # 将所有的文件复制到 output 目录
          cp -rf bin/targets/*/*/* output/

          # 将 .config 配置文件复制到 output 目录为config
          cp -rf .config output/config

          # 切换到 output 目录，进行上传文件前的准备
          cd output/

          # 清理 package 文件夹
          rm -rf packages

          # 对 output 目录中的每个 .bin 文件，生成一个包含其 sha256sum 的文件
          for file in *.bin; do [[ ! -d "${file}" ]] && sha256sum "${file}" >"${file}.sha"; done

          # 将 "status=success" 写入到 GITHUB_OUTPUT 环境变量指定的文件中 表示步骤成功完成
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Clear server space
        id: clean
        if: ${{ steps.output.outputs.status }} == 'success' && !cancelled()
        run: |
          # 清理服务器空间，删除output目录以外的所有文件和目录 
          rm -rf $(ls . | grep -v "^output$" | xargs) 2>/dev/null

          # 显示当前工作目录的磁盘空间使用情况
          df -hT ${PWD}

          # 将 "status=success" 写入到 GITHUB_OUTPUT 环境变量指定的文件中 表示步骤成功完成
          echo "status=success" >> ${GITHUB_OUTPUT}

      - name: Upload OpenWrt to Release
        uses: ncipollo/release-action@main
        if: ${{ steps.clean.outputs.status }} == 'success' && !cancelled()
        with:
          tag: ${{ steps.codes.outputs.build_tag }}
          artifacts: openwrt/output/*
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            # 未经测试
